<!-- admin.html 中的渲染部分，略去顶部引入和样式 -->
<div id="grid"></div>

<script>
  ;(async () => {
    const SUPABASE_URL = 'https://feidochrncyejojvmxog.supabase.co'
    const SUPABASE_ANON = 'sb_publ…nLK9HT7u'
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON)

    const gridEl = document.getElementById('grid')

    try {
      // 1) 取出 signatures 里的所有记录
      const { data: rows, error } = await supabase
        .from('signatures')
        .select('customer_id, path, inserted_at, signature_data')
        .order('inserted_at', { ascending: false })

      if (error) throw error
      if (!rows.length) {
        gridEl.innerText = 'No signatures'
        return
      }

      // 2) 渲染每行
      for (const row of rows) {
        const card = document.createElement('div')
        card.className = 'card'

        // 2.1 签名字图
        const img = document.createElement('img')
        img.className = 'sig-thumb'
        if (row.path) {
          // 如果是存储桶里直接拿 URL
          const { publicURL } = supabase
            .storage
            .from('signatures')
            .getPublicUrl(row.path)
          img.src = publicURL
        } else if (row.signature_data) {
          // 如果是存在 signature_data 字段里的 base64
          img.src = row.signature_data
        }
        card.appendChild(img)

        // 2.2 文本信息
        const info = document.createElement('div')
        info.className = 'info'
        info.innerHTML = `
          <p><strong>ID:</strong> ${row.customer_id}</p>
          <p><strong>Time:</strong> ${new Date(row.inserted_at).toLocaleString()}</p>
        `
        card.appendChild(info)

        // 2.3 下载按钮
        const dl = document.createElement('a')
        dl.className = 'download-btn'
        dl.innerText = 'Download'
        dl.setAttribute('download', `${row.customer_id}_${Date.now()}.png`)
        // href 指向上面生成的 img.src
        dl.href = img.src
        card.appendChild(dl)

        gridEl.appendChild(card)
      }
    } catch (err) {
      gridEl.innerText = 'Error loading data: ' + err.message
    }
  })()
</script>
